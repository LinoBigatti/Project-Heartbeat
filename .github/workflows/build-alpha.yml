on: 
  workflow_dispatch:
  push:
    branches:
      master
      godot4

jobs:
  build-alpha:
    runs-on: ubuntu-latest
    permissions: write-all
    name: Export Dev Build
    steps:
      - name: checkout
        uses: actions/checkout@v3.3.0

      - name: install required packages and update glibc
        run: |
          apt update
          apt install -y p7zip-full
          wget http://mirrors.kernel.org/ubuntu/pool/main/g/glibc/libc6_2.36-0ubuntu4_amd64.deb
          dpkg -i libc6_2.36-0ubuntu4_amd64.deb
      
      - name: set up export presets
        run: |
          mv alpha_build_export_presets.cfg export_presets.cfg

      - name: export pack
        id: export
        uses: firebelley/godot-export@v5.2.0
        with:
          godot_executable_download_url: https://files.catbox.moe/jl6dad.zip
          godot_export_templates_download_url: https://files.catbox.moe/qr14pd.zip
          relative_project_path: ./
          export_debug: true
          export_as_pack: true
          cache: true

      - name: create release
        uses: ncipollo/release-action@v1.12.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          generateReleaseNotes: true
          tag: ${{ github.ref_name }}-${{ github.sha }}-alpha
          artifacts: ${{ steps.export.outputs.archive_directory }}/*
